#!/bin/bash

PACKAGE_NAME="unified-hifi-control"

# Use Synology environment variables for paths
if [ -n "${SYNOPKG_PKGVAR}" ]; then
    PKGVAR="${SYNOPKG_PKGVAR}"
else
    PKGVAR="/var/packages/${PACKAGE_NAME}/var"
fi

if [ -n "${SYNOPKG_PKGDEST}" ]; then
    PKGDEST="${SYNOPKG_PKGDEST}"
else
    PKGDEST="/var/packages/${PACKAGE_NAME}/target"
fi

PID_FILE="${PKGVAR}/${PACKAGE_NAME}.pid"

# Ensure var directory exists
mkdir -p "${PKGVAR}"

# Check if service was running (upgrade scenario - DSM should stop it but be safe)
WAS_RUNNING=false
if [ -f "$PID_FILE" ]; then
    PID=$(cat "$PID_FILE" 2>/dev/null)
    if [ -n "$PID" ] && kill -0 "$PID" 2>/dev/null; then
        WAS_RUNNING=true
        echo "Stopping existing service for upgrade..."
        kill "$PID" 2>/dev/null
        sleep 2
        kill -9 "$PID" 2>/dev/null || true
        rm -f "$PID_FILE"
    fi
fi

# Make binary executable
chmod +x "${PKGDEST}/unified-hifi-control"

# Restart service if it was running before upgrade
if [ "$WAS_RUNNING" = true ]; then
    echo "Restarting service after upgrade..."
    "/var/packages/${PACKAGE_NAME}/scripts/start-stop-status" start
fi

echo "Unified Hi-Fi Control installed successfully"
echo "Access the web UI at http://$(hostname):8088"

exit 0
