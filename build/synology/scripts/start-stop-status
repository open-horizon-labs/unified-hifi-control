#!/bin/bash

PACKAGE_NAME="unified-hifi-control"
PACKAGE_DIR="/var/packages/${PACKAGE_NAME}"
TARGET_DIR="${PACKAGE_DIR}/target"
PID_FILE="/var/run/${PACKAGE_NAME}.pid"
LOG_FILE="/var/log/${PACKAGE_NAME}.log"

start_daemon() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if [ -n "$PID" ] && kill -0 "$PID" 2>/dev/null; then
            echo "${PACKAGE_NAME} is already running"
            return 0
        fi
        # Stale PID file
        rm -f "$PID_FILE"
    fi

    echo "Starting ${PACKAGE_NAME}..."

    if ! cd "${TARGET_DIR}"; then
        echo "Failed to change to ${TARGET_DIR}"
        return 1
    fi

    # Start the binary
    nohup "${TARGET_DIR}/unified-hifi-control" >> "$LOG_FILE" 2>&1 &
    echo $! > "$PID_FILE"

    # Wait for process to start (configurable via STARTUP_WAIT)
    sleep "${STARTUP_WAIT:-2}"

    PID=$(cat "$PID_FILE" 2>/dev/null)
    if [ -n "$PID" ] && kill -0 "$PID" 2>/dev/null; then
        echo "${PACKAGE_NAME} started successfully"
        return 0
    else
        echo "Failed to start ${PACKAGE_NAME}"
        rm -f "$PID_FILE"
        return 1
    fi
}

stop_daemon() {
    if [ ! -f "$PID_FILE" ]; then
        echo "${PACKAGE_NAME} is not running"
        return 0
    fi

    echo "Stopping ${PACKAGE_NAME}..."

    PID=$(cat "$PID_FILE" 2>/dev/null)
    if [ -n "$PID" ] && kill -0 "$PID" 2>/dev/null; then
        kill "$PID"
        sleep 2

        if kill -0 "$PID" 2>/dev/null; then
            kill -9 "$PID"
        fi
    fi

    rm -f "$PID_FILE"
    echo "${PACKAGE_NAME} stopped"
    return 0
}

daemon_status() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE" 2>/dev/null)
        if [ -n "$PID" ] && kill -0 "$PID" 2>/dev/null; then
            return 0  # Running
        fi
    fi
    return 1  # Not running
}

case "$1" in
    start)
        start_daemon
        ;;
    stop)
        stop_daemon
        ;;
    restart)
        stop_daemon
        sleep 1
        start_daemon
        ;;
    status)
        if daemon_status; then
            echo "${PACKAGE_NAME} is running"
            exit 0
        else
            echo "${PACKAGE_NAME} is not running"
            exit 1
        fi
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac
