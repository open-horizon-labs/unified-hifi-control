name: Build Release Installers

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-linux-binaries:
    name: Build Linux/Windows Binaries
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Linux and Windows binaries
        run: |
          node -e "
          const { execSync } = require('child_process');
          const fs = require('fs');
          const path = require('path');
          fs.mkdirSync('dist/bin', { recursive: true });
          const targets = [
            { target: 'node18-linuxstatic-x64', output: 'unified-hifi-linux-x64' },
            { target: 'node18-linuxstatic-arm64', output: 'unified-hifi-linux-arm64' },
            { target: 'node18-win-x64', output: 'unified-hifi-win-x64.exe' },
            { target: 'node18-linuxstatic-x64', output: 'unified-hifi-linux-x86_64', lms: true },
            { target: 'node18-linuxstatic-arm64', output: 'unified-hifi-linux-aarch64', lms: true },
            { target: 'node18-win-x64', output: 'unified-hifi-win64.exe', lms: true },
          ];
          for (const { target, output, lms } of targets) {
            console.log('Building ' + output + '...');
            const entry = lms ? 'src/lms-entry.js' : 'src/index.js';
            const config = lms ? 'pkg-lms.json' : 'package.json';
            execSync('npx pkg \"' + entry + '\" --target ' + target + ' --output dist/bin/' + output + ' --config ' + config, { stdio: 'inherit' });
          }
          "

      - name: Upload Linux/Windows binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-linux-win
          path: dist/bin/
          retention-days: 1

  build-macos-binaries:
    name: Build macOS Binaries
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build macOS binaries
        run: |
          node -e "
          const { execSync } = require('child_process');
          const fs = require('fs');
          fs.mkdirSync('dist/bin', { recursive: true });
          const targets = [
            { target: 'node18-macos-x64', output: 'unified-hifi-macos-x64' },
            { target: 'node18-macos-arm64', output: 'unified-hifi-macos-arm64' },
            { target: 'node18-macos-x64', output: 'unified-hifi-darwin-x86_64', lms: true },
            { target: 'node18-macos-arm64', output: 'unified-hifi-darwin-arm64', lms: true },
          ];
          for (const { target, output, lms } of targets) {
            console.log('Building ' + output + '...');
            const entry = lms ? 'src/lms-entry.js' : 'src/index.js';
            const config = lms ? 'pkg-lms.json' : 'package.json';
            execSync('npx pkg \"' + entry + '\" --target ' + target + ' --output dist/bin/' + output + ' --config ' + config, { stdio: 'inherit' });
          }
          "

      - name: Upload macOS binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-macos
          path: dist/bin/
          retention-days: 1

  build-macos:
    name: Build macOS DMG
    needs: [build-linux-binaries, build-macos-binaries]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Download macOS binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-macos
          path: dist/bin/

      - name: Make binaries executable
        run: chmod +x dist/bin/*

      - name: Build DMG
        run: node scripts/build-installers.js

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/installers/*.dmg
          retention-days: 5

  build-windows:
    name: Build Windows MSI
    needs: [build-linux-binaries, build-macos-binaries]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-linux-win
          path: dist/bin/

      - name: Install WiX Toolset
        run: |
          choco install wixtoolset -y
          echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" >> $env:GITHUB_PATH

      - name: Build MSI
        run: node scripts/build-installers.js

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: dist/installers/*.msi
          retention-days: 5

  build-linux:
    name: Build Linux Packages
    needs: [build-linux-binaries, build-macos-binaries]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-linux-win
          path: dist/bin/

      - name: Make binaries executable
        run: chmod +x dist/bin/*

      - name: Install fpm
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential rpm
          sudo gem install fpm

      - name: Build deb and rpm packages
        run: node scripts/build-installers.js

      - name: Generate Arch PKGBUILD
        run: npm run build:arch

      - name: Upload Linux packages
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            dist/installers/*.deb
            dist/installers/*.rpm
          retention-days: 5

      - name: Upload Arch PKGBUILD
        uses: actions/upload-artifact@v4
        with:
          name: arch-pkgbuild
          path: |
            dist/PKGBUILD
            build/arch/unified-hifi-control.service
          retention-days: 5

  build-lms-plugin:
    name: Build LMS Plugin
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build LMS plugin
        run: npm run build:lms-plugin

      - name: Upload LMS plugin
        uses: actions/upload-artifact@v4
        with:
          name: lms-plugin
          path: dist/lms-unified-hifi-control-*.zip
          retention-days: 5

  build-nas-packages:
    name: Build NAS Packages (Synology/QNAP)
    needs: [build-linux-binaries, build-macos-binaries]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-linux-win
          path: dist/bin/

      - name: Make binaries executable
        run: chmod +x dist/bin/*

      - name: Build NAS packages
        run: npm run build:nas

      - name: Upload Synology packages
        uses: actions/upload-artifact@v4
        with:
          name: synology-packages
          path: dist/installers/*.spk
          retention-days: 5

      - name: Upload QNAP packages
        uses: actions/upload-artifact@v4
        with:
          name: qnap-packages
          path: dist/installers/*.qpkg
          retention-days: 5

  upload-release:
    name: Upload to Release
    needs: [build-linux-binaries, build-macos-binaries, build-macos, build-windows, build-linux, build-lms-plugin, build-nas-packages]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Display structure
        run: ls -R artifacts/

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/binaries-linux-win/*
            artifacts/binaries-macos/*
            artifacts/macos-dmg/*.dmg
            artifacts/windows-msi/*.msi
            artifacts/linux-packages/*.deb
            artifacts/linux-packages/*.rpm
            artifacts/arch-pkgbuild/PKGBUILD
            artifacts/arch-pkgbuild/unified-hifi-control.service
            artifacts/lms-plugin/*.zip
            artifacts/synology-packages/*.spk
            artifacts/qnap-packages/*.qpkg

  update-repo-xml:
    name: Update LMS repo.xml
    needs: upload-release
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: master

      - name: Get release version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Download LMS zip and compute SHA
        id: sha
        run: |
          ZIP_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/lms-unified-hifi-control-${{ steps.version.outputs.version }}.zip"
          echo "Downloading $ZIP_URL"
          curl -sL "$ZIP_URL" -o lms-plugin.zip
          SHA=$(shasum lms-plugin.zip | cut -d' ' -f1)
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "Computed SHA: $SHA"

      - name: Update repo.xml
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SHA="${{ steps.sha.outputs.sha }}"
          REPO_URL="https://github.com/${{ github.repository }}"

          cat > lms-plugin/repo.xml << 'REPOXML'
          <?xml version="1.0" encoding="UTF-8"?>
          <extensions>
            <plugins>
              <plugin name="UnifiedHiFi"
                      version="VERSION_PLACEHOLDER"
                      minTarget="8.0"
                      maxTarget="*">
                <title lang="EN">Unified Hi-Fi Control</title>
                <desc lang="EN">Source-agnostic hi-fi control bridge for Roon, LMS, HQPlayer, and hardware knobs. Provides HTTP APIs, MQTT integration, and web UI for controlling your audio system from anywhere.</desc>
                <url>URL_PLACEHOLDER</url>
                <sha>SHA_PLACEHOLDER</sha>
                <creator>Muness Castle</creator>
                <link>https://forums.lyrion.org/forum/user-forums/3rd-party-hardware/1804977-roon-knob-includes-lms-support</link>
              </plugin>
            </plugins>
          </extensions>
          REPOXML

          # Remove leading whitespace and substitute placeholders
          sed -i 's/^          //' lms-plugin/repo.xml
          sed -i "s|VERSION_PLACEHOLDER|$VERSION|" lms-plugin/repo.xml
          sed -i "s|URL_PLACEHOLDER|${REPO_URL}/releases/download/v${VERSION}/lms-unified-hifi-control-${VERSION}.zip|" lms-plugin/repo.xml
          sed -i "s|SHA_PLACEHOLDER|$SHA|" lms-plugin/repo.xml

          cat lms-plugin/repo.xml

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add lms-plugin/repo.xml
          git commit -m "chore: Update repo.xml to v${{ steps.version.outputs.version }} [skip ci]"
          git push
