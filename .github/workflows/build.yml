name: Build

on:
  pull_request:
    branches: [master, v3]
    types: [opened, synchronize, reopened, labeled]
  push:
    branches: [v3, 'feature/**']
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      build_lms:
        description: 'Build LMS plugin'
        type: boolean
        default: false
      build_synology:
        description: 'Build Synology SPK'
        type: boolean
        default: false
      build_qnap:
        description: 'Build QNAP (x64)'
        type: boolean
        default: false
      build_qnap_arm:
        description: 'Build QNAP (arm64)'
        type: boolean
        default: false
      build_linux_arm:
        description: 'Build Linux ARM (arm64 + armv7)'
        type: boolean
        default: false
      build_macos:
        description: 'Build macOS universal'
        type: boolean
        default: false
      build_windows:
        description: 'Build Windows'
        type: boolean
        default: false
      build_docker:
        description: 'Build Docker (x64)'
        type: boolean
        default: false
      build_linux_packages:
        description: 'Build deb/rpm packages'
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # =============================================================================
  # PLAN: Centralized decision logic for what to build
  # =============================================================================
  # This job runs first (~5s) and computes which builds are needed.
  # All other jobs check plan outputs instead of duplicating condition logic.
  # Benefits: single source of truth, implicit dependency triggering, easier debugging.

  plan:
    name: Plan
    runs-on: ubuntu-latest
    outputs:
      is_release: ${{ steps.decide.outputs.is_release }}
      build_linux_arm: ${{ steps.decide.outputs.build_linux_arm }}
      build_macos: ${{ steps.decide.outputs.build_macos }}
      build_windows: ${{ steps.decide.outputs.build_windows }}
      build_lms: ${{ steps.decide.outputs.build_lms }}
      build_synology: ${{ steps.decide.outputs.build_synology }}
      build_qnap: ${{ steps.decide.outputs.build_qnap }}
      build_qnap_arm: ${{ steps.decide.outputs.build_qnap_arm }}
      build_docker: ${{ steps.decide.outputs.build_docker }}
      build_linux_packages: ${{ steps.decide.outputs.build_linux_packages }}
      lms_matrix: ${{ steps.decide.outputs.lms_matrix }}
    steps:
      - name: Decide what to build
        id: decide
        env:
          EVENT_NAME: ${{ github.event_name }}
          # Labels (only present on PRs)
          HAS_LABEL_ALL: ${{ contains(github.event.pull_request.labels.*.name, 'build:all') }}
          HAS_LABEL_LINUX_ARM: ${{ contains(github.event.pull_request.labels.*.name, 'build:linux-arm') }}
          HAS_LABEL_MACOS: ${{ contains(github.event.pull_request.labels.*.name, 'build:macos') }}
          HAS_LABEL_WINDOWS: ${{ contains(github.event.pull_request.labels.*.name, 'build:windows') }}
          HAS_LABEL_LMS: ${{ contains(github.event.pull_request.labels.*.name, 'build:lms') }}
          HAS_LABEL_LMS_MACOS: ${{ contains(github.event.pull_request.labels.*.name, 'build:lms-macos') }}
          HAS_LABEL_SYNOLOGY: ${{ contains(github.event.pull_request.labels.*.name, 'build:synology') }}
          HAS_LABEL_QNAP: ${{ contains(github.event.pull_request.labels.*.name, 'build:qnap') }}
          HAS_LABEL_QNAP_ARM: ${{ contains(github.event.pull_request.labels.*.name, 'build:qnap-arm') }}
          HAS_LABEL_DOCKER: ${{ contains(github.event.pull_request.labels.*.name, 'build:docker') }}
          HAS_LABEL_LINUX_PACKAGES: ${{ contains(github.event.pull_request.labels.*.name, 'build:linux-packages') }}
          # Inputs (only present on workflow_dispatch)
          INPUT_LINUX_ARM: ${{ inputs.build_linux_arm }}
          INPUT_MACOS: ${{ inputs.build_macos }}
          INPUT_WINDOWS: ${{ inputs.build_windows }}
          INPUT_LMS: ${{ inputs.build_lms }}
          INPUT_SYNOLOGY: ${{ inputs.build_synology }}
          INPUT_QNAP: ${{ inputs.build_qnap }}
          INPUT_QNAP_ARM: ${{ inputs.build_qnap_arm }}
          INPUT_DOCKER: ${{ inputs.build_docker }}
          INPUT_LINUX_PACKAGES: ${{ inputs.build_linux_packages }}
        run: |
          # Helper function
          should_build() {
            [[ "$EVENT_NAME" == "release" ]] && return 0
            [[ "$HAS_LABEL_ALL" == "true" ]] && return 0
            return 1
          }

          # Is this a release?
          IS_RELEASE=$([[ "$EVENT_NAME" == "release" ]] && echo "true" || echo "false")
          echo "is_release=$IS_RELEASE" >> $GITHUB_OUTPUT

          # Linux ARM: needed for ARM binaries, Synology ARM, QNAP ARM, linux packages
          BUILD_LINUX_ARM="false"
          if should_build; then BUILD_LINUX_ARM="true"; fi
          if [[ "$HAS_LABEL_LINUX_ARM" == "true" ]]; then BUILD_LINUX_ARM="true"; fi
          if [[ "$HAS_LABEL_SYNOLOGY" == "true" ]]; then BUILD_LINUX_ARM="true"; fi
          if [[ "$HAS_LABEL_QNAP_ARM" == "true" ]]; then BUILD_LINUX_ARM="true"; fi
          if [[ "$HAS_LABEL_LINUX_PACKAGES" == "true" ]]; then BUILD_LINUX_ARM="true"; fi
          if [[ "$INPUT_LINUX_ARM" == "true" ]]; then BUILD_LINUX_ARM="true"; fi
          if [[ "$INPUT_SYNOLOGY" == "true" ]]; then BUILD_LINUX_ARM="true"; fi
          if [[ "$INPUT_QNAP_ARM" == "true" ]]; then BUILD_LINUX_ARM="true"; fi
          if [[ "$INPUT_LINUX_PACKAGES" == "true" ]]; then BUILD_LINUX_ARM="true"; fi
          echo "build_linux_arm=$BUILD_LINUX_ARM" >> $GITHUB_OUTPUT

          # macOS: also triggered by build:lms-macos label
          BUILD_MACOS="false"
          if should_build; then BUILD_MACOS="true"; fi
          if [[ "$HAS_LABEL_MACOS" == "true" ]]; then BUILD_MACOS="true"; fi
          if [[ "$HAS_LABEL_LMS_MACOS" == "true" ]]; then BUILD_MACOS="true"; fi
          if [[ "$INPUT_MACOS" == "true" ]]; then BUILD_MACOS="true"; fi
          echo "build_macos=$BUILD_MACOS" >> $GITHUB_OUTPUT

          # Windows
          BUILD_WINDOWS="false"
          if should_build; then BUILD_WINDOWS="true"; fi
          if [[ "$HAS_LABEL_WINDOWS" == "true" ]]; then BUILD_WINDOWS="true"; fi
          if [[ "$INPUT_WINDOWS" == "true" ]]; then BUILD_WINDOWS="true"; fi
          echo "build_windows=$BUILD_WINDOWS" >> $GITHUB_OUTPUT

          # LMS Plugin: also triggered by build:lms-macos label
          BUILD_LMS="false"
          if should_build; then BUILD_LMS="true"; fi
          if [[ "$HAS_LABEL_LMS" == "true" ]]; then BUILD_LMS="true"; fi
          if [[ "$HAS_LABEL_LMS_MACOS" == "true" ]]; then BUILD_LMS="true"; fi
          if [[ "$INPUT_LMS" == "true" ]]; then BUILD_LMS="true"; fi
          echo "build_lms=$BUILD_LMS" >> $GITHUB_OUTPUT

          # Synology
          BUILD_SYNOLOGY="false"
          if should_build; then BUILD_SYNOLOGY="true"; fi
          if [[ "$HAS_LABEL_SYNOLOGY" == "true" ]]; then BUILD_SYNOLOGY="true"; fi
          if [[ "$INPUT_SYNOLOGY" == "true" ]]; then BUILD_SYNOLOGY="true"; fi
          echo "build_synology=$BUILD_SYNOLOGY" >> $GITHUB_OUTPUT

          # QNAP x64
          BUILD_QNAP="false"
          if should_build; then BUILD_QNAP="true"; fi
          if [[ "$HAS_LABEL_QNAP" == "true" ]]; then BUILD_QNAP="true"; fi
          if [[ "$INPUT_QNAP" == "true" ]]; then BUILD_QNAP="true"; fi
          echo "build_qnap=$BUILD_QNAP" >> $GITHUB_OUTPUT

          # QNAP ARM
          BUILD_QNAP_ARM="false"
          if should_build; then BUILD_QNAP_ARM="true"; fi
          if [[ "$HAS_LABEL_QNAP_ARM" == "true" ]]; then BUILD_QNAP_ARM="true"; fi
          if [[ "$INPUT_QNAP_ARM" == "true" ]]; then BUILD_QNAP_ARM="true"; fi
          echo "build_qnap_arm=$BUILD_QNAP_ARM" >> $GITHUB_OUTPUT

          # Docker x64
          BUILD_DOCKER="false"
          if should_build; then BUILD_DOCKER="true"; fi
          if [[ "$HAS_LABEL_DOCKER" == "true" ]]; then BUILD_DOCKER="true"; fi
          if [[ "$INPUT_DOCKER" == "true" ]]; then BUILD_DOCKER="true"; fi
          echo "build_docker=$BUILD_DOCKER" >> $GITHUB_OUTPUT

          # Linux packages (deb/rpm)
          BUILD_LINUX_PACKAGES="false"
          if should_build; then BUILD_LINUX_PACKAGES="true"; fi
          if [[ "$HAS_LABEL_LINUX_PACKAGES" == "true" ]]; then BUILD_LINUX_PACKAGES="true"; fi
          if [[ "$INPUT_LINUX_PACKAGES" == "true" ]]; then BUILD_LINUX_PACKAGES="true"; fi
          echo "build_linux_packages=$BUILD_LINUX_PACKAGES" >> $GITHUB_OUTPUT

          # LMS full ZIP matrix - only include platforms whose binaries are built
          LMS_MATRIX='{"include":['
          LMS_FIRST="true"

          # linux-x64 always included when LMS is built (requires linux-x64 which is always built)
          if [[ "$BUILD_LMS" == "true" ]]; then
            LMS_MATRIX="$LMS_MATRIX"'{"platform":"linux-x64","binary_artifact":"binary-x86_64-unknown-linux-musl","binary_name":"unified-hifi-linux-x64","bundled_name":"unified-hifi-control"}'
            LMS_FIRST="false"
          fi

          # linux-arm64 and linux-armv7 require ARM build
          if [[ "$BUILD_LMS" == "true" && "$BUILD_LINUX_ARM" == "true" ]]; then
            [[ "$LMS_FIRST" == "false" ]] && LMS_MATRIX="$LMS_MATRIX,"
            LMS_MATRIX="$LMS_MATRIX"'{"platform":"linux-arm64","binary_artifact":"binary-aarch64-unknown-linux-musl","binary_name":"unified-hifi-linux-arm64","bundled_name":"unified-hifi-control"}'
            LMS_MATRIX="$LMS_MATRIX,"'{"platform":"linux-armv7","binary_artifact":"binary-armv7-unknown-linux-musleabihf","binary_name":"unified-hifi-linux-armv7","bundled_name":"unified-hifi-control"}'
            LMS_FIRST="false"
          fi

          # macos requires macOS build
          if [[ "$BUILD_LMS" == "true" && "$BUILD_MACOS" == "true" ]]; then
            [[ "$LMS_FIRST" == "false" ]] && LMS_MATRIX="$LMS_MATRIX,"
            LMS_MATRIX="$LMS_MATRIX"'{"platform":"macos","binary_artifact":"binary-macos-universal","binary_name":"unified-hifi-macos-universal","bundled_name":"unified-hifi-control"}'
            LMS_FIRST="false"
          fi

          # windows requires Windows build
          if [[ "$BUILD_LMS" == "true" && "$BUILD_WINDOWS" == "true" ]]; then
            [[ "$LMS_FIRST" == "false" ]] && LMS_MATRIX="$LMS_MATRIX,"
            LMS_MATRIX="$LMS_MATRIX"'{"platform":"windows","binary_artifact":"binary-windows","binary_name":"unified-hifi-win64.exe","bundled_name":"unified-hifi-control.exe"}'
          fi

          LMS_MATRIX="$LMS_MATRIX]}"
          echo "lms_matrix=$LMS_MATRIX" >> $GITHUB_OUTPUT

          # Step summary - show label â†’ build mapping
          echo "### Build Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Default:** lint, test, web-assets, linux-x64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Build optional builds table directly
          HAS_OPTIONAL="false"
          TABLE_ROWS=""

          add_row() {
            TABLE_ROWS="${TABLE_ROWS}| $1 | $2 |"$'\n'
            HAS_OPTIONAL="true"
          }

          if [[ "$BUILD_LMS" == "true" ]]; then
            if [[ "$EVENT_NAME" == "release" ]]; then add_row "lms" "release"
            elif [[ "$HAS_LABEL_LMS_MACOS" == "true" ]]; then add_row "lms" "build:lms-macos"
            elif [[ "$HAS_LABEL_LMS" == "true" ]]; then add_row "lms" "build:lms"
            fi
          fi
          if [[ "$BUILD_MACOS" == "true" ]]; then
            if [[ "$EVENT_NAME" == "release" ]]; then add_row "macos" "release"
            elif [[ "$HAS_LABEL_LMS_MACOS" == "true" ]]; then add_row "macos" "build:lms-macos"
            elif [[ "$HAS_LABEL_MACOS" == "true" ]]; then add_row "macos" "build:macos"
            fi
          fi
          if [[ "$BUILD_LINUX_ARM" == "true" ]]; then
            TRIGGER="release"
            [[ "$HAS_LABEL_LINUX_ARM" == "true" ]] && TRIGGER="build:linux-arm"
            [[ "$HAS_LABEL_SYNOLOGY" == "true" ]] && TRIGGER="build:synology (implicit)"
            [[ "$HAS_LABEL_QNAP_ARM" == "true" ]] && TRIGGER="build:qnap-arm (implicit)"
            [[ "$HAS_LABEL_LINUX_PACKAGES" == "true" ]] && TRIGGER="build:linux-packages (implicit)"
            add_row "linux-arm" "$TRIGGER"
          fi
          if [[ "$BUILD_WINDOWS" == "true" ]]; then
            if [[ "$EVENT_NAME" == "release" ]]; then add_row "windows" "release"
            elif [[ "$HAS_LABEL_WINDOWS" == "true" ]]; then add_row "windows" "build:windows"
            fi
          fi
          if [[ "$BUILD_SYNOLOGY" == "true" ]]; then
            if [[ "$EVENT_NAME" == "release" ]]; then add_row "synology" "release"
            elif [[ "$HAS_LABEL_SYNOLOGY" == "true" ]]; then add_row "synology" "build:synology"
            fi
          fi
          if [[ "$BUILD_QNAP" == "true" ]]; then
            if [[ "$EVENT_NAME" == "release" ]]; then add_row "qnap" "release"
            elif [[ "$HAS_LABEL_QNAP" == "true" ]]; then add_row "qnap" "build:qnap"
            fi
          fi
          if [[ "$BUILD_QNAP_ARM" == "true" ]]; then
            if [[ "$EVENT_NAME" == "release" ]]; then add_row "qnap-arm" "release"
            elif [[ "$HAS_LABEL_QNAP_ARM" == "true" ]]; then add_row "qnap-arm" "build:qnap-arm"
            fi
          fi
          if [[ "$BUILD_DOCKER" == "true" ]]; then
            if [[ "$EVENT_NAME" == "release" ]]; then add_row "docker" "release"
            elif [[ "$HAS_LABEL_DOCKER" == "true" ]]; then add_row "docker" "build:docker"
            fi
          fi
          if [[ "$BUILD_LINUX_PACKAGES" == "true" ]]; then
            if [[ "$EVENT_NAME" == "release" ]]; then add_row "linux-packages" "release"
            elif [[ "$HAS_LABEL_LINUX_PACKAGES" == "true" ]]; then add_row "linux-packages" "build:linux-packages"
            fi
          fi

          if [[ "$HAS_OPTIONAL" == "true" ]]; then
            echo "**Optional builds enabled:**" >> $GITHUB_STEP_SUMMARY
            echo "| Build | Triggered by |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|--------------|" >> $GITHUB_STEP_SUMMARY
            printf "%s" "$TABLE_ROWS" >> $GITHUB_STEP_SUMMARY
          else
            echo "_No optional builds enabled. Add labels like \`build:lms\`, \`build:macos\`, etc._" >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # ALWAYS RUN: Lint, Test, Web Assets, Linux x64
  # =============================================================================

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "native-build"
          cache-all-crates: true
          cache-on-failure: true

      - name: Check formatting
        run: cargo fmt --check

      - name: Run clippy
        run: cargo clippy -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "test-build"

      - name: Run tests
        env:
          SCCACHE_GHA_ENABLED: "true"
          RUSTC_WRAPPER: "sccache"
        run: cargo test --workspace

  build-web-assets:
    name: Build Web Assets
    needs: plan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "wasm-build"
          cache-all-crates: true
          cache-on-failure: true
          cache-directories: target/dx

      - name: Cache Dioxus CLI
        id: cache-dx
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/dx
          key: dx-cli-0.7.3

      - name: Install Dioxus CLI
        if: steps.cache-dx.outputs.cache-hit != 'true'
        run: cargo install dioxus-cli@0.7.3 --locked

      - name: Build Tailwind CSS
        run: make css

      - name: Build web assets
        env:
          SCCACHE_GHA_ENABLED: "true"
          RUSTC_WRAPPER: "sccache"
        run: dx build --release --platform web --features web

      - name: Create web assets tarball
        if: needs.plan.outputs.is_release == 'true'
        run: |
          cd target/dx/unified-hifi-control/release/web
          tar -czvf web-assets.tar.gz public/
          mv web-assets.tar.gz ${{ github.workspace }}/

      - name: Upload web assets
        uses: actions/upload-artifact@v4
        with:
          name: web-assets
          path: target/dx/unified-hifi-control/release/web/public/
          retention-days: 5

      - name: Upload web assets tarball
        if: needs.plan.outputs.is_release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: web-assets-tarball
          path: web-assets.tar.gz
          retention-days: 5

  build-linux-x64:
    name: Build Linux x64
    needs: plan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: zigbuild-x86_64-unknown-linux-musl

      - name: Install zig
        run: |
          curl -L https://ziglang.org/download/0.13.0/zig-linux-x86_64-0.13.0.tar.xz | tar -xJ
          sudo mv zig-linux-x86_64-0.13.0 /opt/zig
          echo "/opt/zig" >> $GITHUB_PATH

      - name: Cache cargo-zigbuild
        id: cache-zigbuild
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-zigbuild
          key: cargo-zigbuild-0.20

      - name: Install cargo-zigbuild
        if: steps.cache-zigbuild.outputs.cache-hit != 'true'
        run: cargo install cargo-zigbuild --locked

      - name: Build with zigbuild
        run: cargo zigbuild --release --target x86_64-unknown-linux-musl

      - name: Rename binary
        run: |
          mkdir -p dist/bin
          cp target/x86_64-unknown-linux-musl/release/unified-hifi-control dist/bin/unified-hifi-linux-x64

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-x86_64-unknown-linux-musl
          path: dist/bin/
          retention-days: 5

  # =============================================================================
  # OPTIONAL: Controlled by plan outputs
  # =============================================================================

  build-linux-arm:
    name: Build Linux ARM (${{ matrix.arch }})
    needs: plan
    if: needs.plan.outputs.build_linux_arm == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: aarch64-unknown-linux-musl
            output: unified-hifi-linux-arm64
            arch: arm64
          - target: armv7-unknown-linux-musleabihf
            output: unified-hifi-linux-armv7
            arch: armv7
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: zigbuild-${{ matrix.target }}

      - name: Install zig
        run: |
          curl -L https://ziglang.org/download/0.13.0/zig-linux-x86_64-0.13.0.tar.xz | tar -xJ
          sudo mv zig-linux-x86_64-0.13.0 /opt/zig
          echo "/opt/zig" >> $GITHUB_PATH

      - name: Cache cargo-zigbuild
        id: cache-zigbuild
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-zigbuild
          key: cargo-zigbuild-0.20

      - name: Install cargo-zigbuild
        if: steps.cache-zigbuild.outputs.cache-hit != 'true'
        run: cargo install cargo-zigbuild --locked

      - name: Build with zigbuild
        run: cargo zigbuild --release --target ${{ matrix.target }}

      - name: Smoke test armv7 binary
        if: matrix.target == 'armv7-unknown-linux-musleabihf'
        run: |
          sudo apt-get update && sudo apt-get install -y qemu-user-static
          qemu-arm-static ./target/${{ matrix.target }}/release/unified-hifi-control --version

      - name: Rename binary
        run: |
          mkdir -p dist/bin
          cp target/${{ matrix.target }}/release/unified-hifi-control dist/bin/${{ matrix.output }}

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.target }}
          path: dist/bin/
          retention-days: 5

  build-macos-x64:
    name: Build macOS (x86_64)
    needs: plan
    if: needs.plan.outputs.build_macos == 'true'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: macos-x64

      - name: Build x86_64
        env:
          SCCACHE_GHA_ENABLED: "true"
          RUSTC_WRAPPER: "sccache"
        run: cargo build --release --target x86_64-apple-darwin

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-macos-x64
          path: target/x86_64-apple-darwin/release/unified-hifi-control
          retention-days: 5

  build-macos-arm64:
    name: Build macOS (arm64)
    needs: plan
    if: needs.plan.outputs.build_macos == 'true'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: macos-arm64

      - name: Build aarch64
        env:
          SCCACHE_GHA_ENABLED: "true"
          RUSTC_WRAPPER: "sccache"
        run: cargo build --release --target aarch64-apple-darwin

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-macos-arm64
          path: target/aarch64-apple-darwin/release/unified-hifi-control
          retention-days: 5

  build-macos-universal:
    name: Build macOS (universal)
    needs: [plan, build-macos-x64, build-macos-arm64]
    if: |
      always() &&
      needs.plan.outputs.build_macos == 'true' &&
      needs.build-macos-x64.result == 'success' &&
      needs.build-macos-arm64.result == 'success'
    runs-on: macos-latest
    steps:
      - name: Download x86_64 binary
        uses: actions/download-artifact@v4
        with:
          name: binary-macos-x64
          path: x64/

      - name: Download arm64 binary
        uses: actions/download-artifact@v4
        with:
          name: binary-macos-arm64
          path: arm64/

      - name: Create universal binary with lipo
        run: |
          mkdir -p dist/bin
          lipo -create \
            x64/unified-hifi-control \
            arm64/unified-hifi-control \
            -output dist/bin/unified-hifi-macos-universal
          file dist/bin/unified-hifi-macos-universal

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-macos-universal
          path: dist/bin/
          retention-days: 5

  build-windows:
    name: Build Windows
    needs: plan
    if: needs.plan.outputs.build_windows == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Build
        env:
          SCCACHE_GHA_ENABLED: "true"
          RUSTC_WRAPPER: "sccache"
        run: cargo build --release

      - name: Rename binary
        shell: bash
        run: |
          mkdir -p dist/bin
          cp target/release/unified-hifi-control.exe dist/bin/unified-hifi-win64.exe

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-windows
          path: dist/bin/
          retention-days: 5

  # Bootstrap ZIP: no bundled binaries, downloads on first run
  # This is the default for release builds - smaller download, works on any platform
  build-lms-bootstrap:
    name: Build LMS Plugin (bootstrap)
    needs: plan
    if: needs.plan.outputs.build_lms == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="0.0.0-dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update install.xml version
        run: |
          sed -i "s|<version>[^<]*</version>|<version>${{ steps.version.outputs.version }}</version>|" lms-plugin/install.xml

      - name: Create LMS plugin ZIP
        run: |
          mkdir -p dist
          cd lms-plugin
          zip -r ../dist/lms-unified-hifi-control-${{ steps.version.outputs.version }}.zip . \
            -x "*.git*" \
            -x "Bin/*"
          mkdir -p Bin
          echo "# Binaries downloaded on first run" > Bin/.gitkeep
          zip -r ../dist/lms-unified-hifi-control-${{ steps.version.outputs.version }}.zip Bin/.gitkeep
          rm -rf Bin

      - name: Repack with correct directory structure
        run: |
          cd dist
          mkdir -p repack
          unzip lms-unified-hifi-control-${{ steps.version.outputs.version }}.zip -d repack/UnifiedHiFi
          rm lms-unified-hifi-control-${{ steps.version.outputs.version }}.zip
          cd repack
          zip -r ../lms-unified-hifi-control-${{ steps.version.outputs.version }}.zip UnifiedHiFi
          cd ..
          rm -rf repack

      - name: Upload LMS plugin
        uses: actions/upload-artifact@v4
        with:
          name: lms-plugin-bootstrap
          path: dist/lms-unified-hifi-control-*.zip
          retention-days: 5

  # Full ZIPs: bundled binaries + web assets for each platform
  # Used for PR testing and offline installations
  build-lms-full:
    name: Build LMS Plugin (${{ matrix.platform }})
    needs: [plan, build-web-assets, build-linux-x64, build-linux-arm, build-macos-universal, build-windows]
    if: |
      always() &&
      needs.plan.outputs.build_lms == 'true' &&
      needs.build-web-assets.result == 'success' &&
      needs.build-linux-x64.result == 'success'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.plan.outputs.lms_matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="0.0.0-dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.binary_artifact }}
          path: binary/

      - name: Download web assets
        uses: actions/download-artifact@v4
        with:
          name: web-assets
          path: web-assets/

      - name: Update install.xml version
        run: |
          sed -i "s|<version>[^<]*</version>|<version>${{ steps.version.outputs.version }}</version>|" lms-plugin/install.xml

      - name: Bundle LMS plugin with binary
        run: |
          mkdir -p dist
          cd lms-plugin

          # Create Bin directory with bundled binary
          mkdir -p Bin
          cp ../binary/${{ matrix.binary_name }} Bin/${{ matrix.bundled_name }}
          chmod +x Bin/${{ matrix.bundled_name }}

          # Copy web assets to Bin/public (Dioxus expects public/ next to binary)
          cp -r ../web-assets Bin/public

          # Create ZIP with everything
          zip -r ../dist/lms-unified-hifi-control-${{ steps.version.outputs.version }}-${{ matrix.platform }}.zip . \
            -x "*.git*"

      - name: Repack with correct directory structure
        run: |
          cd dist
          mkdir -p repack
          unzip lms-unified-hifi-control-${{ steps.version.outputs.version }}-${{ matrix.platform }}.zip -d repack/UnifiedHiFi
          rm lms-unified-hifi-control-${{ steps.version.outputs.version }}-${{ matrix.platform }}.zip
          cd repack
          zip -r ../lms-unified-hifi-control-${{ steps.version.outputs.version }}-${{ matrix.platform }}.zip UnifiedHiFi
          cd ..
          rm -rf repack

      - name: Upload LMS plugin
        uses: actions/upload-artifact@v4
        with:
          name: lms-plugin-${{ matrix.platform }}
          path: dist/lms-unified-hifi-control-*.zip
          retention-days: 5

  # =============================================================================
  # PACKAGING: Depends on binaries + web assets
  # =============================================================================

  build-synology:
    name: Build Synology SPK (${{ matrix.arch }})
    needs: [plan, build-linux-x64, build-linux-arm, build-web-assets]
    if: |
      always() &&
      needs.plan.outputs.build_synology == 'true' &&
      needs.build-linux-x64.result == 'success' &&
      needs.build-web-assets.result == 'success'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: apollolake
            target: x86_64-unknown-linux-musl
            binary: unified-hifi-linux-x64
          - arch: rtd1296
            target: aarch64-unknown-linux-musl
            binary: unified-hifi-linux-arm64
    steps:
      - uses: actions/checkout@v4

      - name: Check if binary available
        if: matrix.target == 'aarch64-unknown-linux-musl'
        run: |
          if [[ "${{ needs.build-linux-arm.result }}" != "success" ]]; then
            echo "::warning::ARM build not available, skipping ${{ matrix.arch }}"
            exit 1
          fi

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: binary-${{ matrix.target }}
          path: build/synology/package/

      - name: Download web assets
        uses: actions/download-artifact@v4
        with:
          name: web-assets
          path: build/synology/package/public/

      - name: Rename binary
        run: |
          mv build/synology/package/${{ matrix.binary }} build/synology/package/unified-hifi-control
          chmod +x build/synology/package/unified-hifi-control

      - name: Get version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="0.0.0-dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          sed -i "s/version=\"{{VERSION}}\"/version=\"$VERSION\"/" build/synology/INFO
          sed -i "s/arch=\"{{ARCH}}\"/arch=\"${{ matrix.arch }}\"/" build/synology/INFO

      - name: Build Synology SPK
        run: |
          cd build/synology
          tar -czf package.tgz -C package .
          mkdir -p ../../dist/installers
          SPK_NAME="UnifiedHifiControl-${{ matrix.arch }}-${{ steps.version.outputs.version }}.spk"
          tar -cf "../../dist/installers/${SPK_NAME}" \
            INFO PACKAGE_ICON.PNG PACKAGE_ICON_256.PNG \
            package.tgz scripts conf WIZARD_UIFILES

      - name: Upload Synology package
        uses: actions/upload-artifact@v4
        with:
          name: synology-${{ matrix.arch }}
          path: dist/installers/*.spk
          retention-days: 5

  build-qnap-x64:
    name: Build QNAP (x64)
    needs: [plan, build-linux-x64, build-web-assets]
    if: needs.plan.outputs.build_qnap == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: binary-x86_64-unknown-linux-musl
          path: dist/bin/

      - name: Download web assets
        uses: actions/download-artifact@v4
        with:
          name: web-assets
          path: dist/public/

      - name: Make binary executable
        run: chmod +x dist/bin/*

      - name: Get version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="0.0.0-dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Prepare QNAP package
        run: |
          mkdir -p qnap-build/shared
          cp dist/bin/unified-hifi-linux-x64 qnap-build/shared/unified-hifi-control
          chmod +x qnap-build/shared/unified-hifi-control
          cp -r dist/public qnap-build/shared/public
          cp build/qnap/shared/*.sh qnap-build/shared/
          chmod +x qnap-build/shared/*.sh
          cp -r build/qnap/shared/icons qnap-build/
          sed "s/{{VERSION}}/${{ steps.version.outputs.version }}/" build/qnap/qpkg.cfg > qnap-build/qpkg.cfg
          echo '#!/bin/sh' > qnap-build/package_routines

      - name: Build QPKG with Docker
        run: |
          docker run --rm --platform linux/amd64 \
            -v "$(pwd)/qnap-build:/src" \
            -w /src \
            owncloudci/qnap-qpkg-builder@sha256:e342184e415b1df87ef00b8c1df47988ffd6a9d232a21331556067d400f06189 \
            sh -c '/usr/share/qdk2/QDK/bin/qbuild --build-dir /src/build && cp /src/build/*.qpkg /src/ && chmod 666 /src/*.qpkg'

      - name: Move QPKG to dist
        run: |
          mkdir -p dist/installers
          mv qnap-build/*.qpkg dist/installers/unified-hifi-control_${{ steps.version.outputs.version }}_x86_64.qpkg

      - name: Upload QNAP package
        uses: actions/upload-artifact@v4
        with:
          name: qnap-x86_64
          path: dist/installers/*.qpkg
          retention-days: 5

  build-qnap-arm:
    name: Build QNAP (arm64)
    needs: [plan, build-linux-arm, build-web-assets]
    if: |
      always() &&
      needs.plan.outputs.build_qnap_arm == 'true' &&
      needs.build-linux-arm.result == 'success' &&
      needs.build-web-assets.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: binary-aarch64-unknown-linux-musl
          path: dist/bin/

      - name: Download web assets
        uses: actions/download-artifact@v4
        with:
          name: web-assets
          path: dist/public/

      - name: Make binary executable
        run: chmod +x dist/bin/*

      - name: Get version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="0.0.0-dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Prepare QNAP package
        run: |
          mkdir -p qnap-build/shared
          cp dist/bin/unified-hifi-linux-arm64 qnap-build/shared/unified-hifi-control
          chmod +x qnap-build/shared/unified-hifi-control
          cp -r dist/public qnap-build/shared/public
          cp build/qnap/shared/*.sh qnap-build/shared/
          chmod +x qnap-build/shared/*.sh
          cp -r build/qnap/shared/icons qnap-build/
          sed "s/{{VERSION}}/${{ steps.version.outputs.version }}/" build/qnap/qpkg.cfg > qnap-build/qpkg.cfg
          echo '#!/bin/sh' > qnap-build/package_routines

      - name: Build QPKG with Docker
        run: |
          docker run --rm --platform linux/amd64 \
            -v "$(pwd)/qnap-build:/src" \
            -w /src \
            owncloudci/qnap-qpkg-builder@sha256:e342184e415b1df87ef00b8c1df47988ffd6a9d232a21331556067d400f06189 \
            sh -c '/usr/share/qdk2/QDK/bin/qbuild --build-dir /src/build && cp /src/build/*.qpkg /src/ && chmod 666 /src/*.qpkg'

      - name: Move QPKG to dist
        run: |
          mkdir -p dist/installers
          mv qnap-build/*.qpkg dist/installers/unified-hifi-control_${{ steps.version.outputs.version }}_arm_64.qpkg

      - name: Upload QNAP package
        uses: actions/upload-artifact@v4
        with:
          name: qnap-arm_64
          path: dist/installers/*.qpkg
          retention-days: 5

  build-docker-x64:
    name: Build Docker (x64)
    needs: [plan, build-linux-x64, build-web-assets]
    if: needs.plan.outputs.build_docker == 'true'
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: binary-x86_64-unknown-linux-musl
          path: binaries/

      - name: Download web assets
        uses: actions/download-artifact@v4
        with:
          name: web-assets
          path: public/

      - name: Prepare binary
        run: |
          mv binaries/unified-hifi-linux-x64 binaries/unified-hifi-linux-amd64
          ls -la binaries/ public/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: muness/unified-hifi-control
          tags: |
            type=ref,event=pr
            type=ref,event=branch

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.ci
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # =============================================================================
  # RELEASE ONLY: Multi-arch Docker
  # =============================================================================

  build-docker-release:
    name: Build Docker (${{ matrix.arch }})
    needs: [plan, build-linux-x64, build-linux-arm, build-web-assets]
    if: needs.plan.outputs.is_release == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            target: x86_64-unknown-linux-musl
            binary: unified-hifi-linux-x64
            arch: amd64
          - platform: linux/arm64
            target: aarch64-unknown-linux-musl
            binary: unified-hifi-linux-arm64
            arch: arm64
          - platform: linux/arm/v7
            target: armv7-unknown-linux-musleabihf
            binary: unified-hifi-linux-armv7
            arch: armv7
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: binary-${{ matrix.target }}
          path: dist/

      - name: Download web assets
        uses: actions/download-artifact@v4
        with:
          name: web-assets
          path: dist/public/

      - name: Prepare binary
        run: |
          mv dist/${{ matrix.binary }} dist/unified-hifi-control
          chmod +x dist/unified-hifi-control

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.release
          platforms: ${{ matrix.platform }}
          outputs: type=image,name=muness/unified-hifi-control,push-by-digest=true,name-canonical=true,push=true

      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: docker-digest-${{ matrix.target }}
          path: /tmp/digests/*
          retention-days: 1

  docker-manifest:
    name: Create Docker Manifest
    needs: [plan, build-docker-release]
    if: needs.plan.outputs.is_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download digests
        uses: actions/download-artifact@v4
        with:
          pattern: docker-digest-*
          path: /tmp/digests
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            muness/unified-hifi-control
            muness/roon-extension-knob
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable=${{ !contains(github.ref, '-') }}

      - name: Create manifest list and push
        working-directory: /tmp/digests
        run: |
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf 'muness/unified-hifi-control@sha256:%s ' *)

      - name: Create manifest for legacy image name
        working-directory: /tmp/digests
        run: |
          TAGS=$(jq -cr '.tags | map(select(contains("roon-extension-knob"))) | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON")
          if [ -n "$TAGS" ]; then
            docker buildx imagetools create $TAGS \
              $(printf 'muness/unified-hifi-control@sha256:%s ' *)
          fi

  build-linux-packages:
    name: Build Linux Packages (deb/rpm)
    needs: [plan, build-linux-x64, build-linux-arm, build-web-assets]
    if: |
      always() &&
      needs.plan.outputs.build_linux_packages == 'true' &&
      needs.build-linux-x64.result == 'success' &&
      needs.build-web-assets.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux binaries
        uses: actions/download-artifact@v4
        with:
          pattern: binary-*-linux-*
          path: dist/bin/
          merge-multiple: true

      - name: Download web assets
        uses: actions/download-artifact@v4
        with:
          name: web-assets
          path: dist/public/

      - name: Make binaries executable
        run: chmod +x dist/bin/*

      - name: Install fpm
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential rpm
          sudo gem install fpm

      - name: Get version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="0.0.0-dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build deb package (x64)
        run: |
          fpm -s dir -t deb \
            -n unified-hifi-control \
            -v ${{ steps.version.outputs.version }} \
            --description "Source-agnostic hi-fi control bridge" \
            --url "https://github.com/open-horizon-labs/unified-hifi-control" \
            --license "PolyForm Noncommercial 1.0.0" \
            -a amd64 \
            --after-install build/linux/postinst.sh \
            dist/bin/unified-hifi-linux-x64=/usr/bin/unified-hifi-control \
            dist/public/=/usr/share/unified-hifi-control/public \
            build/linux/unified-hifi-control.service=/etc/systemd/system/unified-hifi-control.service

      - name: Build rpm package (x64)
        run: |
          fpm -s dir -t rpm \
            -n unified-hifi-control \
            -v ${{ steps.version.outputs.version }} \
            --description "Source-agnostic hi-fi control bridge" \
            --url "https://github.com/open-horizon-labs/unified-hifi-control" \
            --license "PolyForm Noncommercial 1.0.0" \
            -a x86_64 \
            --after-install build/linux/postinst.sh \
            dist/bin/unified-hifi-linux-x64=/usr/bin/unified-hifi-control \
            dist/public/=/usr/share/unified-hifi-control/public \
            build/linux/unified-hifi-control.service=/etc/systemd/system/unified-hifi-control.service

      - name: Build deb package (arm64)
        if: hashFiles('dist/bin/unified-hifi-linux-arm64') != ''
        run: |
          fpm -s dir -t deb \
            -n unified-hifi-control \
            -v ${{ steps.version.outputs.version }} \
            --description "Source-agnostic hi-fi control bridge" \
            --url "https://github.com/open-horizon-labs/unified-hifi-control" \
            --license "PolyForm Noncommercial 1.0.0" \
            -a arm64 \
            --after-install build/linux/postinst.sh \
            dist/bin/unified-hifi-linux-arm64=/usr/bin/unified-hifi-control \
            dist/public/=/usr/share/unified-hifi-control/public \
            build/linux/unified-hifi-control.service=/etc/systemd/system/unified-hifi-control.service

      - name: Build deb package (armv7/armhf)
        if: hashFiles('dist/bin/unified-hifi-linux-armv7') != ''
        run: |
          fpm -s dir -t deb \
            -n unified-hifi-control \
            -v ${{ steps.version.outputs.version }} \
            --description "Source-agnostic hi-fi control bridge" \
            --url "https://github.com/open-horizon-labs/unified-hifi-control" \
            --license "PolyForm Noncommercial 1.0.0" \
            -a armhf \
            --after-install build/linux/postinst.sh \
            dist/bin/unified-hifi-linux-armv7=/usr/bin/unified-hifi-control \
            dist/public/=/usr/share/unified-hifi-control/public \
            build/linux/unified-hifi-control.service=/etc/systemd/system/unified-hifi-control.service

      - name: Upload Linux packages
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            *.deb
            *.rpm
          retention-days: 5

  # =============================================================================
  # RELEASE ONLY: Upload to GitHub Release
  # =============================================================================

  upload-release:
    name: Upload to Release
    needs: [plan, build-linux-x64, build-linux-arm, build-macos-universal, build-windows, build-linux-packages, build-lms-bootstrap, build-lms-full, build-synology, build-qnap-x64, build-qnap-arm, build-web-assets]
    if: needs.plan.outputs.is_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Display structure
        run: ls -R artifacts/

      - name: Flatten binaries
        run: |
          mkdir -p release
          find artifacts -name "unified-hifi-*" -type f \
            ! -name "*.js" ! -name "*.wasm" \
            -exec cp {} release/ \;
          find artifacts -name "*.deb" -type f -exec cp {} release/ \;
          find artifacts -name "*.rpm" -type f -exec cp {} release/ \;
          find artifacts -name "*.zip" -type f -exec cp {} release/ \;
          find artifacts -name "*.spk" -type f -exec cp {} release/ \;
          find artifacts -name "*.qpkg" -type f -exec cp {} release/ \;
          find artifacts -name "*.tar.gz" -type f -exec cp {} release/ \;
          ls -la release/

      - name: Generate asset list
        run: |
          cat > release-assets.md << 'EOF'
          ## Download Guide

          ### Standalone Binaries
          | Platform | File |
          |----------|------|
          | Linux x64 | `unified-hifi-linux-x64` |
          | Linux ARM64 | `unified-hifi-linux-arm64` |
          | Linux ARMv7 | `unified-hifi-linux-armv7` |
          | macOS (Universal) | `unified-hifi-macos-universal` |
          | Windows x64 | `unified-hifi-win64.exe` |

          ### Linux Packages
          - `.deb` packages for Debian/Ubuntu
          - `.rpm` packages for Fedora/RHEL

          ### NAS Packages
          - `.spk` for Synology DSM 7+
          - `.qpkg` for QNAP

          ### LMS Plugin
          - `lms-unified-hifi-control-*.zip` - Install via LMS Settings > Plugins

          ### Web Assets
          - `web-assets.tar.gz` - Pre-built web UI (included in packages)
          EOF

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          append_body: true
          body_path: release-assets.md

  update-repo-xml:
    name: Update LMS repo.xml
    needs: [plan, upload-release]
    if: needs.plan.outputs.is_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: v3

      - name: Get release version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Download LMS zip and compute SHA
        id: sha
        run: |
          ZIP_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/lms-unified-hifi-control-${{ steps.version.outputs.version }}.zip"
          echo "Downloading $ZIP_URL"
          curl -fSL --retry 3 --retry-delay 5 "$ZIP_URL" -o lms-plugin.zip
          FILE_SIZE=$(stat -c%s lms-plugin.zip 2>/dev/null || stat -f%z lms-plugin.zip)
          if [ "$FILE_SIZE" -lt 1024 ]; then
            echo "Error: Downloaded file too small ($FILE_SIZE bytes), expected > 1KB"
            exit 1
          fi
          SHA=$(sha1sum lms-plugin.zip | cut -d' ' -f1)
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      - name: Update repo.xml
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SHA="${{ steps.sha.outputs.sha }}"
          REPO_URL="https://github.com/${{ github.repository }}"

          cat > lms-plugin/repo.xml << 'REPOXML'
          <?xml version="1.0" encoding="UTF-8"?>
          <extensions>
            <plugins>
              <plugin name="UnifiedHiFi"
                      version="VERSION_PLACEHOLDER"
                      minTarget="8.0"
                      maxTarget="*">
                <title lang="EN">Unified Hi-Fi Control</title>
                <desc lang="EN">Source-agnostic hi-fi control bridge for Roon, LMS, HQPlayer, and hardware knobs. Provides HTTP APIs, MQTT integration, and web UI for controlling your audio system from anywhere.</desc>
                <url>URL_PLACEHOLDER</url>
                <sha>SHA_PLACEHOLDER</sha>
                <creator>Muness Castle</creator>
                <link>https://forums.lyrion.org/forum/user-forums/3rd-party-hardware/1804977-roon-knob-includes-lms-support</link>
              </plugin>
            </plugins>
          </extensions>
          REPOXML

          sed -i 's/^          //' lms-plugin/repo.xml
          sed -i "s|VERSION_PLACEHOLDER|$VERSION|" lms-plugin/repo.xml
          sed -i "s|URL_PLACEHOLDER|${REPO_URL}/releases/download/v${VERSION}/lms-unified-hifi-control-${VERSION}.zip|" lms-plugin/repo.xml
          sed -i "s|SHA_PLACEHOLDER|$SHA|" lms-plugin/repo.xml

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add lms-plugin/repo.xml
          git commit -m "chore: Update repo.xml to v${{ steps.version.outputs.version }} [skip ci]" || echo "No changes to commit"
          git push

  # =============================================================================
  # Build Summary
  # =============================================================================

  summary:
    name: Build Summary
    needs:
      - plan
      - lint
      - test
      - build-linux-x64
      - build-web-assets
      - build-linux-arm
      - build-macos-universal
      - build-windows
      - build-lms-bootstrap
      - build-lms-full
      - build-synology
      - build-qnap-x64
      - build-qnap-arm
      - build-docker-x64
      - build-docker-release
      - build-linux-packages
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
        continue-on-error: true

      - name: Display build summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Binaries" >> $GITHUB_STEP_SUMMARY
          echo "| Binary | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          find artifacts -name 'unified-hifi-*' -type f 2>/dev/null | while read f; do
            size=$(du -h "$f" | cut -f1)
            name=$(basename "$f")
            echo "| $name | $size |" >> $GITHUB_STEP_SUMMARY
          done || echo "| (none) | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
          find artifacts -name '*.qpkg' -o -name '*.spk' -o -name '*.zip' -o -name '*.deb' -o -name '*.rpm' 2>/dev/null | while read f; do
            size=$(du -h "$f" | cut -f1)
            name=$(basename "$f")
            echo "| $name | $size |" >> $GITHUB_STEP_SUMMARY
          done || echo "| (none) | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Add labels to enable optional builds: build:lms, build:synology, build:qnap-arm, build:linux-arm, build:macos, build:windows, build:all_" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # PR Comment with Artifact Links
  # =============================================================================

  pr-comment:
    name: Post Artifact Links
    needs: [summary]
    if: always() && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Post artifact links to PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const runId = context.runId;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            // Get artifacts for this run
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });

            // Build artifact table
            let artifactTable = '';
            if (artifacts.data.artifacts.length > 0) {
              artifactTable = '| Artifact | Size |\n|----------|------|\n';
              for (const artifact of artifacts.data.artifacts) {
                const size = (artifact.size_in_bytes / 1024 / 1024).toFixed(1) + ' MB';
                artifactTable += `| ${artifact.name} | ${size} |\n`;
              }
            } else {
              artifactTable = '_No artifacts uploaded_';
            }

            const body = `### ðŸ“¦ Build Artifacts

            ${artifactTable}

            [View workflow run](${runUrl}) to download artifacts.

            _Updated: ${new Date().toISOString()}_`;

            // Check if we already posted a comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('Build Artifacts')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body
              });
            }
