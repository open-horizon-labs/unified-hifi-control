[% IF useExtJS; extJsScripts = BLOCK %]
    <script TYPE="text/javascript">
        Ext.onReady(function() {
            new Ext.util.TaskRunner().start({
                run: function() {
                    Ext.Ajax.request({
                        url: knobDevicesUrl,
                        success: function(response, options){
                            response = Ext.util.JSON.decode(response.responseText);
                            getKnobList(response.knobs);
                            Ext.get('helperRunning').show();
                            Ext.get('helperStopped').setDisplayed(false);
                        },
                        failure: function(a, b, c) {
                            Ext.get('helperRunning').setDisplayed(false);
                            Ext.get('helperStopped').show();
                        }
                    });
                },
                interval: 5000
            });
        });
    </script>
[% END; ELSE %]
    <script TYPE="text/javascript" language="JavaScript">
        window.setInterval(function () {
            new Ajax.Request(knobDevicesUrl, {
                method:'get',
                onSuccess: function(response) {
                    getKnobList(response?.responseJSON?.knobs);
                    setIsRunning(response?.status == 200);
                },
                onFailure: function() {
                    setIsRunning(false);
                }
            });
        }, 2000);

        function setIsRunning(isRunning) {
            if (isRunning) {
                $('helperRunning').style.display = 'inline';
                $('helperStopped').style.display = 'none';
            } else {
                $('helperRunning').style.display = 'none';
                $('helperStopped').style.display = 'inline';
            }
        }
    </script>
[% END %]
[% PROCESS settings/header.html %]
    [% title = "PLUGIN_UNIFIED_HIFI" %]

    <script TYPE="text/javascript" language="JavaScript">
        const knobDevicesUrl = '[% webUrl %]/knob/devices';
        const charging = '[% "PLUGIN_UNIFIED_HIFI_KNOB_BATTERY_CHARGING" | string %]';
        const playerIdNameMap = JSON.parse('[% playerIdNameMap | replace("'", "\\'") %]');

        function getKnobList(knobs) {
            if (!(knobs && knobs.length)) {
                return;
            }

            let table = document.getElementById('knobList');
            // Clear existing rows except header
            while (table.rows.length > 1) {
                table.deleteRow(1);
            }

            knobs.sort(function(a, b) {
                return (a.name || a.knob_id).localeCompare(b.name || b.knob_id);
            }).forEach(function(knob) {
                let row = table.insertRow();

                let cellName = row.insertCell(0);
                cellName.textContent = knob.name || 'Knob';

                let cellAction = row.insertCell(1);
                cellAction.textContent = playerIdNameMap[knob.status?.zone_id?.replace('lms:', '')] || knob.status?.zone_id?.replace('lms:', '') || 'Unknown Player';

                let cellIP = row.insertCell(2);
                let ipAddress = knob.status?.ip;
                if (ipAddress) {
                    let link = document.createElement('a');
                    link.href = 'http://' + ipAddress;
                    link.target = '_blank';
                    link.textContent = ipAddress;
                    cellIP.appendChild(link);
                }
                else {
                    cellIP.textContent = 'N/A';
                }

                let cellVersion = row.insertCell(3);
                cellVersion.textContent = knob.version;

                let cellBattery = row.insertCell(4);
                if (knob.status?.battery_level !== undefined) {
                    cellBattery.textContent = (knob.status.battery_level || 0) + '%';
                    if (knob.status.battery_charging) {
                        cellBattery.textContent += ' ' + charging;
                    }
                } else {
                    cellBattery.textContent = 'N/A';
                }
            });
        }
    </script>

    [% WRAPPER setting title="PLUGIN_UNIFIED_HIFI" desc="" %]
    <!-- Binary status warning -->
    [% IF binaryStatus == 'missing' %]
    <div class="prefDesc" style="padding: 10px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; margin-bottom: 15px;">
        [% "PLUGIN_UNIFIED_HIFI_BINARY_MISSING" | string %]
    </div>
    [% END %]

    <!-- Status indicator -->
    <div class="prefDesc">
        <b>[% "PLUGIN_UNIFIED_HIFI_STATUS" | string %]:</b>
        <span id="helperRunning" [% IF !running %]style="display: none;"[% END %]>
            <span style="color: #28a745; font-weight: bold;">
                &#9679; [% "PLUGIN_UNIFIED_HIFI_RUNNING" | string %]
            </span>
            <input type="submit" value="[% "PLUGIN_UNIFIED_HIFI_OPENUI" | string %] &#8594;" onclick="window.open('[% webUrl %]', '_blank'); return false;" />
            <br/>
            <input type="submit" name="stop" value="[% "PLUGIN_UNIFIED_HIFI_STOP_BRIDGE" | string %]" />
        </span>
        <span id="helperStopped" [% IF running %]style="display: none;"[% END %]>
            <span style="color: #dc3545; font-weight: bold;">
                &#9679; [% "PLUGIN_UNIFIED_HIFI_STOPPED" | string %]
            </span>
            <br/>
            <input type="submit" name="start" value="[% "PLUGIN_UNIFIED_HIFI_START_BRIDGE" | string %]" />
        </span>
    </div>
    [% END %]

    [% WRAPPER setting title="PLUGIN_UNIFIED_HIFI_AUTORUN" desc="PLUGIN_UNIFIED_HIFI_AUTORUN_DESC" %]
        <input type="checkbox" name="pref_autorun" id="pref_autorun"
               value="1" [% IF prefs.autorun %]checked[% END %] />
        <label for="pref_autorun">[% "PLUGIN_UNIFIED_HIFI_AUTORUN_ENABLE" | string %]</label>
    [% END %]

    [% WRAPPER setting title="PLUGIN_UNIFIED_HIFI_PORT" desc="PLUGIN_UNIFIED_HIFI_PORT_DESC" %]
        <input type="number" name="pref_port" id="pref_port"
               value="[% prefs.port || 8088 %]" min="1024" max="65535"
               style="width: 80px;" />
    [% END %]

<!-- Knob Configuration Section -->
    <hr/>
    [% WRAPPER setting title="PLUGIN_UNIFIED_HIFI_KNOB" desc="" %]
        <style>
            #knobList th {
                text-align: left;
                padding-right: 15px;
                font-weight: bold;
            }
            #knobList td {
                vertical-align: middle;
                padding-right: 10px;
            }
        </style>
        <table id="knobList">
            <tr>
                <th>[% "PLUGIN_UNIFIED_HIFI_KNOB_NAME" | string %]</th>
                <th>[% "PLUGIN_UNIFIED_HIFI_CONTROLLED_PLAYER" | string %]</th>
                <th>[% "PLUGIN_UNIFIED_HIFI_IP_ADDRESS" | string %]</th>
                <th>[% "PLUGIN_UNIFIED_HIFI_KNOB_FIRMWARE" | string %]</th>
                <th>[% "PLUGIN_UNIFIED_HIFI_KNOB_BATTERY" | string %]</th>
            </tr>
        </table>
    [% END %]
[% PROCESS settings/footer.html %]
